name: Build and Release

on:
  push:
    branches:
      - "main"   # 只有推送到主分支时才尝试打标签
    tags:
      - 'v*'     # 标签也会触发构建（用于发布）

permissions:
  contents: write # 必须要有写权限才能推送标签

jobs:
  # --- JOB 1: 自动打标签 (新增) ---
  auto-tag:
    name: Auto Tag version
    runs-on: ubuntu-latest
    # 只有是普通 Push 到 main 分支时，才运行这个自动打标任务
    if: github.event_name == 'push' && !startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 必须拉取完整历史，否则无法计算版本号

      - name: Bump version and push tag
        id: tag_version
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          default_bump: patch  # 默认增加补丁号 (v1.0.0 -> v1.0.1)
          # 如果不想每次都发版，可以将 dry_run 设置为 true 进行测试
          
  # --- JOB 2: 编译与发布 (原有逻辑) ---
  build:
    name: Build for ${{ matrix.os }}/${{ matrix.arch }}
    runs-on: ubuntu-latest
    needs: auto-tag # (可选) 或者是并行运行，但通常我们要确保标签打上了
    # 逻辑说明：
    # 1. 如果是 auto-tag 推送了新标签，GitHub 会再次触发这个 workflow (因为 on: tags)，
    #    那一次运行会执行 Release。
    # 2. 如果是手动 Push，这里也会跑一次编译测试 (Artifact)。
    strategy:
      matrix:
        include:
          - os: linux
            arch: amd64
            filename: relay-linux-amd64
          - os: linux
            arch: arm64
            filename: relay-linux-arm64
          - os: darwin
            arch: amd64
            filename: relay-darwin-amd64
          - os: darwin
            arch: arm64
            filename: relay-darwin-arm64

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'

    - name: Download dependencies
      run: go mod download

    - name: Build Binary
      env:
        GOOS: ${{ matrix.os }}
        GOARCH: ${{ matrix.arch }}
        CGO_ENABLED: 0 
      run: |
        go build -ldflags "-s -w" -o ${{ matrix.filename }} main.go

    # 普通 Push 时的产物 (Artifacts)
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      if: startsWith(github.ref, 'refs/tags/') == false
      with:
        name: binary-${{ matrix.os }}-${{ matrix.arch }}
        path: ${{ matrix.filename }}
        retention-days: 5

    # 标签触发时的产物 (Release)
    - name: Upload Release Asset
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: ${{ matrix.filename }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
